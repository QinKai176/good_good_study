## 第五章  创建高性能的索引

### 5.1 索引的基础

#### 5.1.1 索引常见的存储引擎和对应的索引类型

| 存储引擎 | 索引类型                        | 特点                |
| -------- | ------------------------------- | ------------------- |
| innodb   | b-tree索引                      | 如下                |
| Myisam   | R-TREE(空间数据索引),b-tree索引 | 等值匹配，比如说url |
| Archive  |                                 |                     |
| memory   | hash索引                        |                     |

#### 5.1.2  b-tree的特点  

索引列的顺序特别重要！！！

a.全值匹配

b.匹配最左索引

c.匹配列索引

d.匹配范围值

e.精确匹配某一列并且范围内匹配另外一列



限制：

a.如果不是按照索引的最左列开始查找，则无法使用索引

b.不能跳过索引中的列

c.如果查询中有某个列的范围查询，则其右边所有列都无法使用索引优化查找。







### 附录

#### 1.哪些情况需要建立索引

```
a.主键自动建立唯一索引
b.频繁作为查询条件的字段应该建立索引
c.查询中与其他表关联的字段，外键关系建立索引
d.频繁更新的字段不适合创建索引
e.where条件用不到的字段不创建索引
f.单键/组合索引的选择问题
g.查询中排序的字段，排序字段若通过索引访问将大大提高排序速度
h.查询中统计或分组字段
```

#### 2.哪些情况不要创建索引

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg1gd7hdghj31vy0u0qr2.jpg)

```
a.表记录太少
b.经常增删改的表
c.数据列包含许多重复的内容
d.使用or时，or后面的字段要建索引，不然会失效。
```

#### 3.索引的选择性是什么

```
索引的选择性是指索引列中不同值的数目与表中记录数的比。一个索引的选择性越接近1，索引的效率就越高。
```

#### 4.什么是索引

```
索引是一种排好序的数据结构，默认是b+树；

优势：提高查询效率，可以类比字典。降低数据库的IO成本，降低cpu的消耗；

劣势：占用大量的空间；降低更新速度，还要更新索引；
```

#### 5.优化mysql

```
a.id
id：当id相同的时候，由上往下执行；当id不同时，id越大，优先级就越高，优先执行；

b.select_type和table
select_type:查询的类型：主要用来区别普通查询，联合查询，子查询等的复杂查询

Simple:简单的select查询，查询中不包含子查询或者union

primary:查询中若包含任何复杂的子部分，最外层查询被标记为primary

Subquery:在select或者where列表中包含了子查询
Derived: 在from列表中包含的子查询被标记为Deived(衍生)
Union:若第二个select出现在union之后，则被标记为union
Union Result: 


c.
type:性能从高到低：system > const > eq_ref > ref >  range > index > all
一般来说，至少达到range级别，最好能达到ref
system:表只有一行数据（等于系统表），这是const类型的特例，几乎不会出现
const:通过索引一次就找到了，一般是primary key或unique索引，因为只匹配到一行数据。
eq_ref:唯一性索引匹配
ref:非唯一性索引扫描，返回匹配某个单独值的所有行。
range:范围扫描索引
index：全表扫描，读取索引
all:全表扫描，不读取索引
一般来说，至少保证达到range级别，最好能达到ref; 


d.rows
rows表示查询结果大概需要读取的行数，所以行数越少越好

e.extra
表示不适合在其他列显示但是却非常重要的信息
```

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg9fimxy3mj31o00rqapa.jpg)

#### 6.索引两表优化：

```
a.左连接加右表索引
b.右连接建左表索引
```

#### 7.索引三表优化

```
左连接后两表建索引：后两行的type都是ref，而且总rows优化不错。
```

#### 8.join语句的优化

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg9fh871h9j31li0sie00.jpg)

#### 9.遇到%开头的sql

复合索引，建立索引name,age,

查询explain  select id,name,age from tb1_user where name like '%aa%'，索引失效。





 